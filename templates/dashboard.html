{% extends 'base.html' %}

{% block title %}Dashboard - FITTECH{% endblock %}

{% block extra_css %}
<style>
.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2.5rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    text-align: center;
    box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
}

.dashboard-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.dashboard-header p {
    font-size: 1.125rem;
    opacity: 0.95;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.8rem;
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-left: 4px solid var(--primary-color);
    text-decoration: none;
    color: inherit;
    display: block;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    cursor: pointer;
}

.stat-card.no-link {
    cursor: default;
}

.stat-card.no-link:hover {
    transform: none;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.stat-card h3 {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-card .number {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--primary-color);
}

.stat-card.success {
    border-left-color: var(--success-color);
}

.stat-card.success .number {
    color: var(--success-color);
}

.stat-card.warning {
    border-left-color: var(--warning-color);
}

.stat-card.warning .number {
    color: var(--warning-color);
}

.stat-card.danger {
    border-left-color: var(--danger-color);
}

.stat-card.danger .number {
    color: var(--danger-color);
}

.chart-container {
    background: white;
    padding: 2rem;
    border-radius: 14px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 2rem;
}

.chart-container h2 {
    font-size: 1.4rem;
    color: var(--dark-color);
    margin-bottom: 1.5rem;
    font-weight: 700;
    padding-left: 1rem;
    border-left: 4px solid var(--primary-color);
}

.charts-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.registro-rapido {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    padding: 2rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    color: white;
    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
}

.registro-rapido h2 {
    font-size: 1.6rem;
    margin-bottom: 0.8rem;
    font-weight: 700;
}

.registro-rapido p {
    margin-bottom: 1.2rem;
    font-size: 1rem;
    opacity: 0.95;
}

.registro-form {
    display: flex;
    gap: 1rem;
    align-items: flex-end;
}

.registro-form input {
    flex: 1;
    padding: 0.9rem 1rem;
    border: 2px solid rgba(255, 255, 255, 0.5);
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    transition: all 0.3s;
}

.registro-form input::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.registro-form input:focus {
    outline: none;
    border-color: white;
    background: rgba(255, 255, 255, 0.3);
}

.registro-form button {
    padding: 0.9rem 2rem;
    background: white;
    color: #10b981;
    border: none;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
}

.registro-form button:hover {
    background: #f0fdf4;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.mensaje-registro {
    margin-top: 1rem;
    padding: 1rem 1.2rem;
    border-radius: 10px;
    font-weight: 600;
    display: none;
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.mensaje-registro.success {
    background: #d1fae5;
    color: #065f46;
    border-left: 4px solid #10b981;
}

.mensaje-registro.error {
    background: #fee2e2;
    color: #991b1b;
    border-left: 4px solid #ef4444;
}

.alert-card {
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border-left: 4px solid;
}

.alert-card h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
    font-weight: 700;
}

.alert-card p {
    font-size: 1rem;
    margin-bottom: 1rem;
    font-weight: 600;
}

@media (max-width: 768px) {
    .charts-row {
        grid-template-columns: 1fr;
    }

    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .registro-form {
        flex-direction: column;
        align-items: stretch;
    }

    .registro-form button {
        width: 100%;
    }

    .dashboard-header h1 {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Dashboard FITTECH</h1>
    <p>Bienvenido, {{ usuario.nombre }} - {{ usuario.get_rol_display }}</p>
</div>

<div class="registro-rapido">
    <h2>Registro R√°pido de Asistencia</h2>
    <p>Ingresa el documento del cliente para registrar su asistencia</p>
    <form class="registro-form" id="formRegistroRapido">
        {% csrf_token %}
        <input type="text" id="documentoInput" name="documento" placeholder="Ingrese documento del cliente" required autocomplete="off" autofocus>
        <button type="submit">Registrar Asistencia</button>
    </form>
    <div id="mensajeRegistro" class="mensaje-registro"></div>
</div>

<div class="stats-grid">
    <!-- Total Clientes (Clickeable) -->
    <a href="{% url 'clientes_listar' %}" class="stat-card">
        <h3>Total Clientes</h3>
        <div class="number">{{ total_clientes }}</div>
    </a>
    
    <!-- Clientes Activos (Clickeable) -->
    <a href="{% url 'clientes_listar' %}?estado=activo" class="stat-card success">
        <h3>Clientes Activos</h3>
        <div class="number">{{ clientes_activos }}</div>
    </a>
    
    <!-- Asistencias Hoy (Clickeable) -->
    <a href="{% url 'asistencias_listar' %}" class="stat-card">
        <h3>Asistencias Hoy</h3>
        <div class="number" id="asistenciasHoyNumero">{{ asistencias_hoy }}</div>
    </a>
    
    <!-- Ingresos del Mes (NO clickeable) -->
    <div class="stat-card success no-link">
        <h3>Ingresos del Mes</h3>
        <div class="number">${{ ingresos_mes_actual|floatformat:0 }}</div>
    </div>
    
    <!-- Ingresos Hoy (NO clickeable) -->
    <div class="stat-card success no-link">
        <h3>Ingresos Hoy</h3>
        <div class="number">${{ ingresos_hoy|floatformat:0 }}</div>
    </div>
    
    <!-- Pagos Pendientes (Clickeable) -->
    <a href="{% url 'pagos_listar' %}?filtro=pendientes" class="stat-card warning">
        <h3>Pagos Pendientes</h3>
        <div class="number">{{ pagos_pendientes }}</div>
    </a>
    
    <!-- Por Vencer (Clickeable) -->
    <a href="{% url 'clientes_listar' %}?estado=por_vencer" class="stat-card warning">
        <h3>Por Vencer (7 d√≠as)</h3>
        <div class="number">{{ clientes_por_vencer.count }}</div>
    </a>
    
    <!-- Membres√≠as Vencidas (Clickeable) -->
    <a href="{% url 'clientes_listar' %}?estado=inactivo" class="stat-card danger">
        <h3>Membres√≠as Vencidas</h3>
        <div class="number">{{ clientes_vencidos.count }}</div>
    </a>
</div>

<div class="chart-container">
    <h2>üìà Ingresos de los √öltimos 6 Meses</h2>
    <canvas id="ingresosChart" height="80"></canvas>
</div>

<div class="charts-row">
    <div class="chart-container">
        <h2>‚úÖ Asistencias (√öltimos 7 D√≠as)</h2>
        <canvas id="asistenciasChart"></canvas>
    </div>
    <div class="chart-container">
        <h2>üë• Estado de Clientes</h2>
        <canvas id="clientesChart"></canvas>
    </div>
</div>

<div class="charts-row">
    <div class="chart-container">
        <h2>üí≥ Clientes por Membres√≠a</h2>
        <canvas id="membresiasChart"></canvas>
    </div>
    <div class="chart-container">
        <h2>üí∞ Ingresos por M√©todo de Pago (30 d√≠as)</h2>
        <canvas id="metodosChart"></canvas>
    </div>
</div>

{% if clientes_vencidos %}
<div class="alert-card" style="background: #fee2e2; border-left-color: var(--danger-color);">
    <h2 style="color: var(--danger-color);">‚ö†Ô∏è Clientes con Membres√≠as Vencidas</h2>
    <p style="color: #991b1b;">Hay {{ clientes_vencidos.count }} cliente{% if clientes_vencidos.count != 1 %}s{% endif %} con membres√≠as vencidas que requieren atenci√≥n.</p>
    <a href="{% url 'clientes_listar' %}?estado=inactivo" class="btn btn-danger">Ver Clientes</a>
</div>
{% endif %}

{% if clientes_por_vencer %}
<div class="alert-card" style="background: #fef3c7; border-left-color: var(--warning-color);">
    <h2 style="color: #92400e;">üìÖ Clientes por Vencer (Pr√≥ximos 7 d√≠as)</h2>
    <p style="color: #92400e;">Hay {{ clientes_por_vencer.count }} cliente{% if clientes_por_vencer.count != 1 %}s{% endif %} cuyas membres√≠as vencer√°n pronto.</p>
    <a href="{% url 'clientes_listar' %}?estado=por_vencer" class="btn btn-warning" style="background: var(--warning-color);">Ver Clientes por Vencer</a>
</div>
{% endif %}

{% if pagos_pendientes > 0 %}
<div class="alert-card" style="background: #dbeafe; border-left-color: var(--primary-color);">
    <h2 style="color: var(--primary-color);">üí≥ Pagos Pendientes de Validaci√≥n</h2>
    <p style="color: #1e40af;">Hay {{ pagos_pendientes }} pago{% if pagos_pendientes != 1 %}s{% endif %} pendiente{% if pagos_pendientes != 1 %}s{% endif %} de validaci√≥n.</p>
    {% if user.rol == 'administrador' %}
    <a href="{% url 'pagos_listar' %}?filtro=pendientes" class="btn btn-primary">
        Revisar Pagos
    </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
(function(){
    const formRegistro = document.getElementById('formRegistroRapido');
    const documentoInput = document.getElementById('documentoInput');
    const mensajeDiv = document.getElementById('mensajeRegistro');
    const asistenciasNumero = document.getElementById('asistenciasHoyNumero');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    formRegistro.addEventListener('submit', function(e) {
        e.preventDefault();
        const documento = documentoInput.value.trim();
        if(!documento) return;

        fetch('{% url "asistencias_registrar" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrftoken
            },
            body: 'documento=' + encodeURIComponent(documento)
        })
        .then(response => response.json())
        .then(data => {
            mensajeDiv.style.display = 'block';
            if (data.success) {
                mensajeDiv.className = 'mensaje-registro success';
                mensajeDiv.innerHTML = '‚úì ' + data.message + '<br><strong>Cliente:</strong> ' + data.cliente + '<br><strong>Hora:</strong> ' + data.hora;
                const actual = parseInt(asistenciasNumero.textContent) || 0;
                asistenciasNumero.textContent = actual + 1;
                documentoInput.value = '';
                setTimeout(() => { mensajeDiv.style.display = 'none'; }, 5000);
            } else {
                mensajeDiv.className = 'mensaje-registro error';
                mensajeDiv.textContent = '‚úó ' + data.message;
                documentoInput.value = '';
                setTimeout(() => { mensajeDiv.style.display = 'none'; }, 5000);
            }
            documentoInput.focus();
        })
        .catch(error => {
            mensajeDiv.style.display = 'block';
            mensajeDiv.className = 'mensaje-registro error';
            mensajeDiv.textContent = '‚úó Error de conexi√≥n. Intente nuevamente.';
            console.error('Error:', error);
        });
    });

    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    Chart.defaults.font.size = 14;

    new Chart(document.getElementById('ingresosChart'), {
        type: 'line',
        data: {
            labels: {{ meses_labels|safe }},
            datasets: [{
                label: 'Ingresos (COP)',
                data: {{ meses_ingresos|safe }},
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderColor: 'rgba(99, 102, 241, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true, position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            return 'Ingresos: $' + ctx.parsed.y.toLocaleString('es-CO') + ' COP';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: function(val) { return '$' + val.toLocaleString('es-CO'); } }
                }
            }
        }
    });

    new Chart(document.getElementById('asistenciasChart'), {
        type: 'bar',
        data: {
            labels: {{ dias_labels|safe }},
            datasets: [{
                label: 'Asistencias',
                data: {{ dias_asistencias|safe }},
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgba(16, 185, 129, 1)',
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
        }
    });

    new Chart(document.getElementById('clientesChart'), {
        type: 'doughnut',
        data: {
            labels: ['Activos', 'Inactivos'],
            datasets: [{
                data: [{{ clientes_activos }}, {{ clientes_inactivos }}],
                backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                borderColor: ['rgba(16, 185, 129, 1)', 'rgba(239, 68, 68, 1)'],
                borderWidth: 2
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    new Chart(document.getElementById('membresiasChart'), {
        type: 'pie',
        data: {
            labels: {{ membresias_labels|safe }},
            datasets: [{
                data: {{ membresias_valores|safe }},
                backgroundColor: [
                    'rgba(99, 102, 241, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)'
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });

    new Chart(document.getElementById('metodosChart'), {
        type: 'bar',
        data: {
            labels: {{ metodos_labels|safe }},
            datasets: [{
                label: 'Ingresos (COP)',
                data: {{ metodos_valores|safe }},
                backgroundColor: [
                    'rgba(99, 102, 241, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)',
                    'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)'
                ],
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            return 'Ingresos: $' + ctx.parsed.x.toLocaleString('es-CO') + ' COP';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { callback: function(val) { return '$' + val.toLocaleString('es-CO'); } }
                }
            }
        }
    });
})();
</script>
{% endblock %}